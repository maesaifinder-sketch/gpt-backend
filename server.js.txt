import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import OpenAI from "openai";

dotenv.config();

const app = express();

/** ✅ CORS: อนุญาตทุก origin ก่อน (ง่ายสุด)
 *  ถ้าจะล็อกโดเมนทีหลัง ผมปรับให้ได้
 */
app.use(cors());
app.use(express.json({ limit: "1mb" }));

const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

app.get("/health", (req, res) => {
  res.json({ ok: true, service: "prompt-backend" });
});

app.post("/api/generate-gpt-prompt", async (req, res) => {
  try {
    const soraPrompt = String(req.body?.soraPrompt || "").trim();
    if (!soraPrompt) {
      return res.status(400).json({ success: false, error: "Missing soraPrompt" });
    }
    if (!process.env.OPENAI_API_KEY) {
      return res.status(500).json({ success: false, error: "Missing OPENAI_API_KEY" });
    }

    const system = `
คุณคือผู้ช่วยสร้าง "GPT Prompt" สำหรับใช้ผลิตสคริปต์/พรมต์วิดีโอ UGC แบบมืออาชีพ
เป้าหมาย: แปลงข้อมูลจาก Sora Prompt ให้เป็น "GPT Prompt" ที่ชัดเจน เป็นขั้นตอน และใช้งานได้ทันที

ข้อกำหนดเอาต์พุต:
- ตอบกลับเป็นข้อความล้วน (plain text)
- ห้ามใส่โค้ดบล็อก
- จัดรูปแบบเป็นหัวข้อสั้นๆ + bullet
- ต้องมีส่วน: OBJECTIVE, INPUTS, CONSTRAINTS, OUTPUT FORMAT, CHECKLIST
- ภาษาไทยล้วน อ่านง่าย
    `.trim();

    const user = `
นี่คือ Sora Prompt ต้นทาง:
---
${soraPrompt}
---

โปรดสร้าง "GPT Prompt" ที่เหมาะสำหรับนำไปให้ GPT สร้างสคริปต์/พรมต์ต่อได้ทันที
    `.trim();

    const response = await client.responses.create({
      model: "gpt-4.1-mini",
      input: [
        { role: "system", content: system },
        { role: "user", content: user }
      ],
      temperature: 0.3,
      max_output_tokens: 1200
    });

    const promptText = (response.output_text || "").trim();
    if (!promptText) {
      return res.status(502).json({ success: false, error: "Empty response from model" });
    }

    res.json({ success: true, prompt: promptText });
  } catch (err) {
    console.error(err);
    res.status(err?.status || 500).json({ success: false, error: err?.message || "Server error" });
  }
});

const port = Number(process.env.PORT || 3000);
app.listen(port, () => console.log(`✅ Running on port ${port}`));